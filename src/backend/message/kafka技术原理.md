# kafka架构设计
## 持久化设计
kafka深度依赖文件系统来存储或者缓存message。磁盘的快慢取决于使用的方式。
现代操作系统依赖
基于pagecache进行设计，磁盘顺序写有时候比内存随机写更快。
相当于缓存可以扩大一倍，在JVM环境下甚至扩大更多。
![img.png](img.png)
### 读写常数时间复杂度
持久化队列，读写互相不阻塞
## kafka如何保证高性能
### 零拷贝技术
一般情况下，读写服务端应用程序请求磁盘数据并发送给客户端需要经历一下步骤：
1. DMA（直接内存访问）将数据从磁盘中复制到内核缓冲区（PageCache）
2. CPU将数据从内核缓冲区复制到用户缓冲区（发生一次上下文切换）
3. CPU将数据从用户缓冲区复制到socket缓冲区（发生第二次上下文切换）
4. DMA将数据从socket缓冲区复制到网卡
一共发生**四次**数据复制，**两次**上下文切换

可以看到数据最终是从磁盘拷贝到了网卡，中间的两次复制完全没有必要，
而基于零拷贝技术，可以将中间两层的复制操作移除，直接从PageCache复制到网络
### 端到端压缩
